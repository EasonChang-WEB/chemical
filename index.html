<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>化學學習小幫手</title>
    <!-- 引入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入 React 和 Babel -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fadeIn 0.3s ease-out forwards;
        }
        body {
            font-family: "Microsoft JhengHei", "Heiti TC", sans-serif;
            background-color: #f8fafc;
        }
        /* 週期表 Grid 設定 */
        .periodic-grid {
            display: grid;
            grid-template-columns: repeat(18, minmax(42px, 1fr)); /* 稍微調整寬度 */
            gap: 1px; /* 間距縮小，讓線條更緊密 */
            background-color: #cbd5e1; /* 背景色作為格線顏色 (slate-300) */
            padding: 1px;
            border: 1px solid #cbd5e1;
            border-radius: 4px;
        }
        .periodic-cell {
            aspect-ratio: 5 / 6;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background-color: white; /* 格子為白色 */
            position: relative;
        }
        /* 空格部分設定為透明背景，顯示出背景的灰色，或直接隱藏 */
        .periodic-cell.empty {
            background-color: transparent;
            box-shadow: none;
        }
        .symbol {
            font-weight: 800;
            font-size: 1.1rem;
            line-height: 1.1;
        }
        .name {
            font-size: 0.85rem;
            font-weight: 500;
            margin-top: 2px;
        }
        /* 手機版微調 */
        @media (max-width: 640px) {
            .symbol { font-size: 1rem; }
            .name { font-size: 0.75rem; }
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // --- ICON 元件 ---
        const Icons = {
            ArrowLeft: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></svg>,
            CheckCircle: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><path d="m22 4-12 12-1.09-1.09"/></svg>,
            XCircle: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"/><path d="m15 9-6 6"/><path d="m9 9 6 6"/></svg>,
            Beaker: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M4.5 3h15"/><path d="M6 3v16a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V3"/><path d="M6 14h12"/></svg>,
            BookOpen: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>,
            PenTool: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m12 19 7-7 3 3-7 7-3-3z"/><path d="m18 13-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"/><path d="m2 2 7.586 7.586"/><circle cx="11" cy="11" r="2"/></svg>,
            RefreshCw: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></svg>,
            Grid: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><line x1="3" y1="9" x2="21" y2="9"/><line x1="3" y1="15" x2="21" y2="15"/><line x1="9" y1="3" x2="9" y2="21"/><line x1="15" y1="3" x2="15" y2="21"/></svg>,
            List: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg>,
            Bulb: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M15 14c.2-1 .7-1.7 1.5-2.5 1-1 1.5-2.2 1.5-3.5 0-3.3-2.7-6-6-6S6 4.7 6 8c0 1.3.5 2.5 1.5 3.5.8.8 1.3 1.5 1.5 2.5"/><path d="M9 18h6"/><path d="M10 22h4"/></svg>,
            Sparkles: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/><path d="M5 3v4"/><path d="M9 5H5"/><path d="M19 19v2"/><path d="M21 21h-2"/></svg>
        };

        // --- 資料 1: 根價與離子 ---
        const VALENCE_DATA = [
            { name: "氫離子", formula: "H", valence: "+1" }, { name: "鋰離子", formula: "Li", valence: "+1" },
            { name: "鈉離子", formula: "Na", valence: "+1" }, { name: "鉀離子", formula: "K", valence: "+1" },
            { name: "銀離子", formula: "Ag", valence: "+1" }, { name: "氟離子", formula: "F", valence: "-1" },
            { name: "氯離子", formula: "Cl", valence: "-1" }, { name: "溴離子", formula: "Br", valence: "-1" },
            { name: "碘離子", formula: "I", valence: "-1" }, { name: "氫氧根", formula: "OH", valence: "-1" },
            { name: "硝酸根", formula: "NO3", valence: "-1" }, { name: "醋酸根", formula: "CH3COO", valence: "-1" },
            { name: "碳酸氫根", formula: "HCO3", valence: "-1" }, { name: "鎂離子", formula: "Mg", valence: "+2" },
            { name: "鈣離子", formula: "Ca", valence: "+2" }, { name: "鋇離子", formula: "Ba", valence: "+2" },
            { name: "鋅離子", formula: "Zn", valence: "+2" }, { name: "鉛離子", formula: "Pb", valence: "+2" },
            { name: "銅離子", formula: "Cu", valence: "+2" }, { name: "亞鐵離子", formula: "Fe", valence: "+2" },
            { name: "亞鈷離子", formula: "Co", valence: "+2" }, { name: "氧離子", formula: "O", valence: "-2" },
            { name: "硫離子", formula: "S", valence: "-2" }, { name: "硫酸根", formula: "SO4", valence: "-2" },
            { name: "亞硫酸根", formula: "SO3", valence: "-2" }, { name: "碳酸根", formula: "CO3", valence: "-2" },
            { name: "錳離子", formula: "Mn", valence: "+4" },
        ];

        // --- 資料 2: 週期表元素 ---
        const PERIODIC_ELEMENTS = [
            { s: 'H', n: '氫', r: 1, c: 1 }, { s: 'Li', n: '鋰', r: 2, c: 1 }, { s: 'Na', n: '鈉', r: 3, c: 1 }, { s: 'K', n: '鉀', r: 4, c: 1 }, { s: 'Rb', n: '銣', r: 5, c: 1 }, { s: 'Cs', n: '銫', r: 6, c: 1 }, { s: 'Fr', n: '砝', r: 7, c: 1 },
            { s: 'Be', n: '鈹', r: 2, c: 2 }, { s: 'Mg', n: '鎂', r: 3, c: 2 }, { s: 'Ca', n: '鈣', r: 4, c: 2 }, { s: 'Sr', n: '鍶', r: 5, c: 2 }, { s: 'Ba', n: '鋇', r: 6, c: 2 }, { s: 'Ra', n: '鐳', r: 7, c: 2 },
            { s: 'Cr', n: '鉻', r: 4, c: 6 }, { s: 'Mn', n: '錳', r: 4, c: 7 }, { s: 'Fe', n: '鐵', r: 4, c: 8 }, { s: 'Co', n: '鈷', r: 4, c: 9 }, { s: 'Ni', n: '鎳', r: 4, c: 10 }, { s: 'Cu', n: '銅', r: 4, c: 11 }, { s: 'Zn', n: '鋅', r: 4, c: 12 },
            { s: 'W', n: '鎢', r: 6, c: 6 }, { s: 'Pt', n: '鉑', r: 6, c: 10 }, { s: 'Ag', n: '銀', r: 5, c: 11 }, { s: 'Au', n: '金', r: 6, c: 11 }, { s: 'Cd', n: '鎘', r: 5, c: 12 }, { s: 'Hg', n: '汞', r: 6, c: 12 },
            { s: 'B', n: '硼', r: 2, c: 13 }, { s: 'Al', n: '鋁', r: 3, c: 13 },
            { s: 'C', n: '碳', r: 2, c: 14 }, { s: 'Pb', n: '鉛', r: 6, c: 14 },
            { s: 'N', n: '氮', r: 2, c: 15 }, { s: 'P', n: '磷', r: 3, c: 15 }, { s: 'As', n: '砷', r: 4, c: 15 },
            { s: 'O', n: '氧', r: 2, c: 16 }, { s: 'S', n: '硫', r: 3, c: 16 },
            { s: 'F', n: '氟', r: 2, c: 17 }, { s: 'Cl', n: '氯', r: 3, c: 17 }, { s: 'Br', n: '溴', r: 4, c: 17 }, { s: 'I', n: '碘', r: 5, c: 17 }, { s: 'At', n: '砈', r: 6, c: 17 },
            { s: 'He', n: '氦', r: 1, c: 18 }, { s: 'Ne', n: '氖', r: 2, c: 18 }, { s: 'Ar', n: '氬', r: 3, c: 18 }, { s: 'Kr', n: '氪', r: 4, c: 18 }, { s: 'Xe', n: '氙', r: 5, c: 18 }, { s: 'Rn', n: '氡', r: 6, c: 18 },
            { s: 'U', n: '鈾', r: 9, c: 6, isInner: true }
        ];

        // --- 週期表族群記憶法資料 ---
        const MNEMONICS = [
            { title: "IA族 (鹼金族)", elements: "H, Li, Na, K, Rb, Cs, Fr", text: "請李娜加入色法", sub: "氫鋰鈉鉀銣銫砝" },
            { title: "IIA族 (鹼土族)", elements: "Be, Mg, Ca, Sr, Ba, Ra", text: "比美蓋斯貝雷", sub: "鈹鎂鈣鍶鋇鐳" },
            { title: "IIIA族 (硼族)", elements: "B, Al...", text: "捧女 (硼鋁)", sub: "硼鋁" },
            { title: "IVA族 (碳族)", elements: "C, Si, Ge, Sn, Pb", text: "探試者西遷 (或 嘆錢-碳鉛)", sub: "碳矽鍺錫鉛" },
            { title: "VA族 (氮族)", elements: "N, P, As, Sb, Bi", text: "蛋林生弟畢", sub: "氮磷砷銻鉍" },
            { title: "VIA族 (氧族)", elements: "O, S, Se, Te, Po", text: "養牛洗屁股", sub: "氧硫硒碲釙" },
            { title: "VIIA族 (鹵素)", elements: "F, Cl, Br, I, At", text: "父女繡點愛 (氟氯溴碘砈)", sub: "氟氯溴碘砈" },
            { title: "VIIIA族 (惰性氣體)", elements: "He, Ne, Ar, Kr, Xe, Rn", text: "害乃亞克先冬", sub: "氦氖氬氪氙氡" },
            { title: "過渡元素 (第四週期)", elements: "Cr, Mn, Fe, Co, Ni, Cu, Zn", text: "各猛鐵姑捏痛心", sub: "鉻錳鐵鈷鎳銅鋅" },
        ];
        
        // --- 根價離子記憶法資料 ---
        const VALENCE_MNEMONICS = [
            { title: "+1 價陽離子", elements: "H, Li, Na, K, Ag", text: "請李娜嫁銀", sub: "氫鋰鈉鉀銀" },
            { title: "+2 價陽離子", elements: "Mg, Ca, Ba, Zn, Pb, Cu, Fe(II)", text: "美蓋被，心痛欠壓貼", sub: "鎂鈣鋇，鋅銅鉛亞鐵" },
            { title: "-1 價鹵素離子", elements: "F, Cl, Br, I", text: "父女繡點", sub: "氟氯溴碘" },
            { title: "-1 價常見根", elements: "OH, NO3, CH3COO", text: "青笑吃醋", sub: "氫(氧) 硝(酸) 醋(酸)" },
            { title: "-2 價家族", elements: "O, S, SO4, CO3", text: "楊柳 流汗 燙傷", sub: "氧 硫 硫酸 碳酸" },
        ];

        // --- 中英對照 (符號) 記憶法 ---
        const SYMBOL_MNEMONICS = [
            { symbol: "Ag", name: "銀", hint: "阿公(Ag) 有銀子", type: "metal" },
            { symbol: "Au", name: "金", hint: "哎喲(Au)！金子耶！", type: "metal" },
            { symbol: "Cu", name: "銅", hint: "See you (Cu) 銅學", type: "metal" },
            { symbol: "Fe", name: "鐵", hint: "飛(Fe) 鐵俠 (鋼鐵人)", type: "metal" },
            { symbol: "Pb", name: "鉛", hint: "跑步(Pb) 腿像灌鉛", type: "metal" },
            { symbol: "Hg", name: "汞", hint: "很高(Hg) 的溫度計", type: "metal" },
            { symbol: "Mn", name: "錳", hint: "猛(Mn) 男", type: "metal" },
            { symbol: "Zn", name: "鋅", hint: "真(Zn) 辛(鋅)苦", type: "metal" },
            { symbol: "Mg", name: "鎂", hint: "美極(Mg) 了", type: "metal" },
            { symbol: "Ca", name: "鈣", hint: "卡(Ca) 住缺鈣", type: "metal" },
            { symbol: "K", name: "鉀", hint: "K金 鎧(K)甲", type: "metal" },
            { symbol: "Ba", name: "鋇", hint: "爸(Ba) 是寶貝(鋇)", type: "metal" },
            { symbol: "Na", name: "鈉", hint: "吶(Na)喊", type: "metal" },
            { symbol: "F", name: "氟", hint: "福(F) 氣(氟)", type: "nonmetal" },
            { symbol: "Si", name: "矽", hint: "吸(Si) 管(矽)", type: "nonmetal" },
            { symbol: "P", name: "磷", hint: "皮(P) 膚有鱗(磷)", type: "nonmetal" },
            { symbol: "S", name: "硫", hint: "S 曲線流(硫)動", type: "nonmetal" },
        ];

        // --- 工具函數 ---
        const formatFormula = (formula) => {
            return formula.split('').map((char, index) => {
                if (/\d/.test(char)) {
                    return <sub key={index} className="text-[0.6em] align-baseline relative top-1">{char}</sub>;
                }
                return <span key={index}>{char}</span>;
            });
        };

        const shuffleArray = (array) => {
            let arr = [...array];
            for (let i = arr.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [arr[i], arr[j]] = [arr[j], arr[i]];
            }
            return arr;
        };

        // --- 主程式 ---
        function App() {
            const [view, setView] = useState('home'); // home, list_menu, list_valence, list_periodic, quiz1_menu, quiz1_valence, quiz1_element, quiz2

            // 導航處理
            const goHome = () => setView('home');
            const goBack = () => {
                if (view.startsWith('list_')) setView('list_menu');
                else if (view.startsWith('quiz1_')) setView('quiz1_menu');
                else setView('home');
            };

            return (
                <div className="min-h-screen bg-slate-50 font-sans text-slate-800">
                    <header className="bg-teal-600 text-white p-4 shadow-md sticky top-0 z-20">
                        <div className="max-w-2xl mx-auto flex items-center justify-between">
                            <h1 className="text-xl font-bold flex items-center gap-2">
                                <Icons.Beaker className="w-6 h-6" />
                                化學學習小幫手
                            </h1>
                            {view !== 'home' && (
                                <button onClick={view === 'list_menu' || view === 'quiz1_menu' || view === 'quiz2' ? goHome : goBack} className="bg-teal-700 hover:bg-teal-800 p-2 rounded-full transition-colors">
                                    <Icons.ArrowLeft />
                                </button>
                            )}
                        </div>
                    </header>

                    <main className="max-w-2xl mx-auto p-4">
                        {view === 'home' && <HomeMenu setView={setView} />}
                        
                        {/* 列表選單與視圖 */}
                        {view === 'list_menu' && <ListMenu setView={setView} />}
                        {view === 'list_valence' && <ValenceListView />}
                        {view === 'list_periodic' && <PeriodicTableView />}

                        {/* 測驗一選單與視圖 */}
                        {view === 'quiz1_menu' && <Quiz1Menu setView={setView} />}
                        {view === 'quiz1_valence' && <QuizMode1_Valence />}
                        {view === 'quiz1_element' && <QuizMode1_Element />}

                        {/* 測驗二視圖 */}
                        {view === 'quiz2' && <QuizMode2_Mixed />}
                    </main>
                </div>
            );
        }

        // --- 選單元件 ---
        function HomeMenu({ setView }) {
            return (
                <div className="flex flex-col gap-6 mt-8 animate-fade-in">
                    <div className="text-center mb-4">
                        <h2 className="text-2xl font-bold text-teal-800">歡迎回來！</h2>
                        <p className="text-slate-500">請選擇今天的學習模式</p>
                    </div>
                    <MenuButton icon={<Icons.BookOpen className="w-8 h-8 text-blue-500" />} title="化學式總表" desc="依根價或週期表瀏覽" onClick={() => setView('list_menu')} color="border-blue-200 hover:bg-blue-50" />
                    <MenuButton icon={<Icons.PenTool className="w-8 h-8 text-purple-500" />} title="測驗：中翻英" desc="看中文 -> 寫化學式/元素符號" onClick={() => setView('quiz1_menu')} color="border-purple-200 hover:bg-purple-50" />
                    <MenuButton icon={<Icons.RefreshCw className="w-8 h-8 text-orange-500" />} title="測驗：英翻中" desc="綜合混合題型" onClick={() => setView('quiz2')} color="border-orange-200 hover:bg-orange-50" />
                </div>
            );
        }

        function ListMenu({ setView }) {
            return (
                <div className="flex flex-col gap-6 mt-8 animate-fade-in">
                    <h2 className="text-xl font-bold text-center text-slate-700">選擇瀏覽方式</h2>
                    <MenuButton icon={<Icons.List className="w-8 h-8 text-teal-500" />} title="依根價排列" desc="依 +1, +2, -1 等分類" onClick={() => setView('list_valence')} color="border-teal-200 hover:bg-teal-50" />
                    <MenuButton icon={<Icons.Grid className="w-8 h-8 text-indigo-500" />} title="依週期表排列" desc="查看元素位置" onClick={() => setView('list_periodic')} color="border-indigo-200 hover:bg-indigo-50" />
                </div>
            );
        }

        function Quiz1Menu({ setView }) {
            return (
                <div className="flex flex-col gap-6 mt-8 animate-fade-in">
                    <h2 className="text-xl font-bold text-center text-slate-700">選擇測驗類型 (中翻英)</h2>
                    <MenuButton icon={<Icons.Beaker className="w-8 h-8 text-pink-500" />} title="化學式及根價" desc="例如：氫離子 -> H +1" onClick={() => setView('quiz1_valence')} color="border-pink-200 hover:bg-pink-50" />
                    <MenuButton icon={<Icons.Grid className="w-8 h-8 text-green-500" />} title="元素符號" desc="例如：氦 -> He" onClick={() => setView('quiz1_element')} color="border-green-200 hover:bg-green-50" />
                </div>
            );
        }

        function MenuButton({ icon, title, desc, onClick, color }) {
            return (
                <button onClick={onClick} className={`flex items-center gap-4 p-6 bg-white rounded-2xl shadow-sm border-2 ${color} transition-all active:scale-95 text-left w-full`}>
                    <div className="p-3 bg-slate-50 rounded-xl">{icon}</div>
                    <div>
                        <h3 className="text-lg font-bold text-slate-800">{title}</h3>
                        <p className="text-sm text-slate-500">{desc}</p>
                    </div>
                </button>
            );
        }

        // --- 功能 1.1: 依根價列表 ---
        function ValenceListView() {
            // 定義顯示順序
            const order = ["+1", "+2", "+4", "-1", "-2"];
            
            return (
                <div className="space-y-6 animate-fade-in pb-10">
                    <div className="bg-white p-4 rounded-xl shadow-sm border border-slate-200 text-center">
                        <h2 className="font-bold text-lg text-slate-700">化學式總表</h2>
                    </div>
                    
                    {/* 化學式 Grid */}
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4">
                        {order.map(val => (
                            <div key={val} className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden flex flex-col">
                                <div className={`p-3 font-bold text-center text-white ${val.startsWith('+') ? 'bg-blue-500' : 'bg-red-500'}`}>
                                    根價 {val}
                                </div>
                                <div className="divide-y divide-slate-100">
                                    {VALENCE_DATA.filter(item => item.valence === val).map((item, idx) => (
                                        <div key={idx} className="p-3 flex justify-between items-center hover:bg-slate-50">
                                            <span className="text-slate-700 text-sm font-medium">{item.name}</span>
                                            <span className="font-mono font-bold text-teal-600 text-lg">{formatFormula(item.formula)}</span>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        ))}
                    </div>
                    
                    {/* 中英對照 (符號) 記憶法 - 新增區塊 */}
                    <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden mt-8">
                        <div className="bg-amber-50 p-4 border-b border-amber-100 flex items-center gap-2">
                            <Icons.Sparkles className="w-6 h-6 text-amber-500" />
                            <h2 className="font-bold text-lg text-amber-800">中英對照超強聯想 (諧音/趣味)</h2>
                        </div>
                        <div className="p-4 grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3">
                            {SYMBOL_MNEMONICS.map((m, idx) => (
                                <div key={idx} className={`p-3 rounded-lg border flex flex-col items-center text-center ${
                                    m.type === 'metal' ? 'bg-slate-50 border-slate-200' : 'bg-green-50 border-green-200'
                                }`}>
                                    <div className="flex items-center gap-2 mb-1">
                                        <span className="text-xl font-black text-slate-800">{m.symbol}</span>
                                        <span className="text-sm font-bold text-slate-500">{m.name}</span>
                                    </div>
                                    <div className="text-sm font-bold text-amber-700">{m.hint}</div>
                                </div>
                            ))}
                        </div>
                        <div className="p-2 bg-amber-50/50 text-center text-xs text-amber-600">
                           ★ 透過諧音或故事，把英文符號和中文名稱串起來！
                        </div>
                    </div>

                    {/* 超強記憶法 (離子) */}
                    <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden mt-8">
                        <div className="bg-pink-50 p-4 border-b border-pink-100 flex items-center gap-2">
                            <Icons.Bulb className="w-6 h-6 text-pink-500" />
                            <h2 className="font-bold text-lg text-pink-800">離子超強記憶法</h2>
                        </div>
                        <div className="p-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                            {VALENCE_MNEMONICS.map((m, idx) => (
                                <div key={idx} className="bg-slate-50 rounded-lg p-4 border border-slate-100 hover:bg-white hover:shadow-md transition-all">
                                    <div className="flex justify-between items-start mb-2">
                                        <h3 className="font-bold text-slate-700 text-sm">{m.title}</h3>
                                        <span className="text-[10px] text-slate-400 bg-white px-1 border rounded">{m.elements}</span>
                                    </div>
                                    <div className="text-lg font-bold text-pink-600 mb-1">{m.text}</div>
                                    <div className="text-xs text-slate-500">{m.sub}</div>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        }

        // --- 功能 1.2: 依週期表列表 ---
        function PeriodicTableView() {
            // 建立 18x10 的 grid (多預留給錒系)
            const gridCells = [];
            for(let r=1; r<=9; r++) {
                for(let c=1; c<=18; c++) {
                    const el = PERIODIC_ELEMENTS.find(e => e.r === r && e.c === c);
                    gridCells.push({ r, c, el });
                }
            }

            return (
                <div className="animate-fade-in space-y-8 pb-10">
                    <div className="bg-white p-2 rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                        <div className="p-2 border-b border-slate-100 mb-2 flex justify-between items-center">
                            <h2 className="font-bold text-lg text-slate-700">元素週期表</h2>
                            <span className="text-xs text-slate-500 bg-slate-100 px-2 py-1 rounded">可左右滑動</span>
                        </div>
                        <div className="overflow-x-auto pb-4">
                            <div className="min-w-[900px] px-2"> {/* 加寬最小寬度，讓格子變大 */}
                                <div className="periodic-grid mb-2">
                                    {gridCells.map((cell, idx) => {
                                        if (!cell.el) {
                                            return <div key={idx} className="periodic-cell empty"></div>;
                                        }
                                        return (
                                            <div key={idx} className={`periodic-cell border ${cell.el ? 'border-slate-300 shadow-sm hover:border-teal-500 hover:shadow-md cursor-default' : 'border-transparent'}`}>
                                                <span className="text-teal-700 periodic-symbol symbol">{cell.el.s}</span>
                                                <span className="text-slate-600 name">{cell.el.n}</span>
                                            </div>
                                        );
                                    })}
                                </div>
                                <div className="text-center text-sm text-slate-400 mt-2 font-medium">
                                    (註：鈾 U 位於下方錒系元素區)
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* 超強記憶法區塊 (週期表 - 族群) */}
                    <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                        <div className="bg-indigo-50 p-4 border-b border-indigo-100 flex items-center gap-2">
                            <Icons.Bulb className="w-6 h-6 text-indigo-500" />
                            <h2 className="font-bold text-lg text-indigo-800">族群超強記憶法</h2>
                        </div>
                        <div className="p-4 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            {MNEMONICS.map((m, idx) => (
                                <div key={idx} className="bg-slate-50 rounded-lg p-4 border border-slate-100 hover:bg-white hover:shadow-md transition-all">
                                    <div className="flex justify-between items-start mb-2">
                                        <h3 className="font-bold text-slate-700 text-sm">{m.title}</h3>
                                        <span className="text-[10px] text-slate-400 bg-white px-1 border rounded">{m.elements}</span>
                                    </div>
                                    <div className="text-lg font-bold text-indigo-600 mb-1">{m.text}</div>
                                    <div className="text-xs text-slate-500">{m.sub}</div>
                                </div>
                            ))}
                        </div>
                    </div>

                    {/* 超強記憶法區塊 (中英對照 - 符號) */}
                    <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                        <div className="bg-amber-50 p-4 border-b border-amber-100 flex items-center gap-2">
                            <Icons.Sparkles className="w-6 h-6 text-amber-500" />
                            <h2 className="font-bold text-lg text-amber-800">元素符號超強聯想 (諧音/趣味)</h2>
                        </div>
                        <div className="p-4 grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3">
                            {SYMBOL_MNEMONICS.map((m, idx) => (
                                <div key={idx} className={`p-3 rounded-lg border flex flex-col items-center text-center ${
                                    m.type === 'metal' ? 'bg-slate-50 border-slate-200' : 'bg-green-50 border-green-200'
                                }`}>
                                    <div className="flex items-center gap-2 mb-1">
                                        <span className="text-xl font-black text-slate-800">{m.symbol}</span>
                                        <span className="text-sm font-bold text-slate-500">{m.name}</span>
                                    </div>
                                    <div className="text-sm font-bold text-amber-700">{m.hint}</div>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        }

        // --- 測驗共用邏輯 ---
        function QuizRunner({ pool, type, onFinish }) { 
            // type: 'valence' (需填化學式+根價), 'element' (需填符號), 'mixed' (混合)
            const [questions, setQuestions] = useState([]);
            const [currentIndex, setCurrentIndex] = useState(0);
            const [score, setScore] = useState(0);
            const [isFinished, setIsFinished] = useState(false);
            
            // Input states
            const [input1, setInput1] = useState(""); // Formula or Name
            const [input2, setInput2] = useState("+1"); // Valence (if needed)
            
            const [feedback, setFeedback] = useState(null);

            // 初始化：隨機取 20 題
            useEffect(() => {
                const shuffled = shuffleArray(pool);
                setQuestions(shuffled.slice(0, 20));
            }, [pool]);

            if (questions.length === 0) return null;

            const currentQ = questions[currentIndex];
            const isLast = currentIndex === 19;

            // 處理回答
            const handleSubmit = () => {
                let isCorrect = false;
                let correctAnsText = "";

                if (type === 'valence') { // Q: 中文, A: 化學式 + 根價
                    const cleanInput = input1.trim().toLowerCase().replace(/\s+/g, '');
                    const cleanTarget = currentQ.formula.toLowerCase();
                    const isValCorrect = input2 === currentQ.valence;
                    isCorrect = (cleanInput === cleanTarget) && isValCorrect;
                    correctAnsText = `${currentQ.formula} ${currentQ.valence}`;
                } 
                else if (type === 'element') { // Q: 中文, A: 符號
                    const cleanInput = input1.trim().toLowerCase().replace(/\s+/g, '');
                    const cleanTarget = currentQ.s.toLowerCase(); // s for symbol
                    isCorrect = cleanInput === cleanTarget;
                    correctAnsText = currentQ.s;
                }
                else if (type === 'mixed') { // Q: 化學式/符號, A: 中文
                    const userVal = input1.trim();
                    // 判斷是離子題目還是元素題目
                    if (currentQ.valence) { // 離子
                        // 移除 "離子" 或 "根" 來比對核心字
                        const core = currentQ.name.replace("離子", "").replace("根", "");
                        isCorrect = (userVal === currentQ.name || userVal === core);
                        correctAnsText = currentQ.name;
                    } else { // 元素
                        isCorrect = (userVal === currentQ.n);
                        correctAnsText = currentQ.n;
                    }
                }

                if (isCorrect) setScore(s => s + 5);

                setFeedback({
                    isCorrect,
                    correctAnsText
                });
            };

            const handleNext = () => {
                setFeedback(null);
                setInput1("");
                setInput2("+1");
                if (isLast) {
                    setIsFinished(true);
                } else {
                    setCurrentIndex(c => c + 1);
                }
            };

            const handleKeyDown = (e) => {
                // 防止輸入法 (IME) 選字時觸發提交
                if (e.nativeEvent.isComposing) return;
                
                if (e.key === 'Enter') {
                    if (feedback) handleNext(); // 如果已顯示結果，Enter 下一題
                    else if (input1) handleSubmit(); // 如果作答中，Enter 送出
                }
            };

            if (isFinished) {
                return (
                    <div className="bg-white rounded-xl shadow-lg p-8 text-center animate-fade-in flex flex-col gap-6 items-center">
                        <div className="w-20 h-20 bg-teal-100 rounded-full flex items-center justify-center mx-auto">
                            <Icons.CheckCircle className="w-10 h-10 text-teal-600" />
                        </div>
                        <div>
                            <h2 className="text-2xl font-bold text-slate-800 mb-2">測驗完成！</h2>
                            <p className="text-slate-500">總分結算</p>
                        </div>
                        <div className="bg-slate-50 rounded-lg p-6 w-full border-2 border-teal-100">
                            <div className="text-5xl font-black text-teal-600">
                                {score} <span className="text-lg text-slate-400 font-normal">分</span>
                            </div>
                            <p className="text-sm text-slate-400 mt-2">答對 {score/5} 題 / 共 20 題</p>
                        </div>
                        <p className="text-xs text-slate-400">請按左上角返回選單</p>
                    </div>
                );
            }

            return (
                <div className="flex flex-col gap-4 animate-fade-in max-w-md mx-auto">
                    {/* 進度條 */}
                    <div className="flex justify-between items-center text-sm font-medium text-slate-500 px-2">
                        <span>Q {currentIndex + 1} / 20</span>
                        <span>分數: {score}</span>
                    </div>
                    <div className="h-2 bg-slate-200 rounded-full overflow-hidden">
                        <div className="h-full bg-teal-500 transition-all duration-300" style={{ width: `${((currentIndex) / 20) * 100}%` }} />
                    </div>

                    {/* 題目卡 */}
                    <div className="bg-white rounded-xl shadow-lg border-b-4 border-teal-600 p-8 flex flex-col items-center">
                        
                        {/* 題目顯示區 */}
                        <div className="mb-6 text-center">
                            <h3 className="text-slate-400 text-xs font-bold uppercase tracking-widest mb-2">
                                {type === 'mixed' ? "請填寫中文名稱" : "請填寫對應內容"}
                            </h3>
                            <div className="text-4xl font-bold text-slate-800">
                                {type === 'valence' && currentQ.name}
                                {type === 'element' && currentQ.n}
                                {type === 'mixed' && (
                                    currentQ.valence ? (
                                        <div className="flex items-start justify-center gap-1 font-mono text-teal-600">
                                            {formatFormula(currentQ.formula)}
                                            <span className="text-xl text-slate-400 mt-[-5px]">{currentQ.valence}</span>
                                        </div>
                                    ) : (
                                        <span className="font-mono text-teal-600">{currentQ.s}</span>
                                    )
                                )}
                            </div>
                        </div>

                        {/* 作答區 */}
                        <div className="w-full space-y-4">
                            {type === 'valence' && (
                                <div className="flex gap-2">
                                    <input 
                                        type="text" value={input1} onChange={e => setInput1(e.target.value)} onKeyDown={handleKeyDown}
                                        placeholder="化學式 (如: H)"
                                        className="flex-1 bg-slate-50 border-2 border-slate-200 rounded-xl px-4 py-3 text-lg font-mono text-center focus:border-teal-500 outline-none"
                                    />
                                    <select 
                                        value={input2} onChange={e => setInput2(e.target.value)}
                                        className="w-1/3 bg-slate-50 border-2 border-slate-200 rounded-xl px-2 py-3 text-lg font-bold text-center focus:border-teal-500 outline-none"
                                    >
                                        {["+1", "+2", "+4", "-1", "-2"].map(v => <option key={v} value={v}>{v}</option>)}
                                    </select>
                                </div>
                            )}

                            {type === 'element' && (
                                <input 
                                    type="text" value={input1} onChange={e => setInput1(e.target.value)} onKeyDown={handleKeyDown}
                                    placeholder="元素符號 (如: He)"
                                    className="w-full bg-slate-50 border-2 border-slate-200 rounded-xl px-4 py-3 text-lg font-mono text-center focus:border-teal-500 outline-none"
                                />
                            )}

                            {type === 'mixed' && (
                                <div className="flex items-center justify-center gap-2 text-xl">
                                    {currentQ.valence ? (
                                        <>
                                            <span className="text-slate-400">(</span>
                                            <input 
                                                type="text" value={input1} onChange={e => setInput1(e.target.value)} onKeyDown={handleKeyDown}
                                                className="w-32 border-b-2 border-slate-300 bg-transparent text-center font-bold focus:border-teal-500 outline-none"
                                            />
                                            <span className="text-slate-400">)</span>
                                            <span className="font-bold text-slate-700 text-base">
                                                {currentQ.name.includes("離子") ? "離子" : "根"}
                                            </span>
                                        </>
                                    ) : (
                                        <input 
                                            type="text" value={input1} onChange={e => setInput1(e.target.value)} onKeyDown={handleKeyDown}
                                            placeholder="輸入中文"
                                            className="w-full bg-slate-50 border-2 border-slate-200 rounded-xl px-4 py-3 text-center font-bold focus:border-teal-500 outline-none"
                                        />
                                    )}
                                </div>
                            )}

                            <button 
                                onClick={handleSubmit}
                                disabled={!input1}
                                className="w-full bg-teal-600 hover:bg-teal-700 disabled:bg-slate-300 disabled:cursor-not-allowed text-white font-bold py-3 rounded-xl shadow active:scale-95 transition-all"
                            >
                                回答 (Enter)
                            </button>
                        </div>
                    </div>

                    {/* 回饋視窗 */}
                    {feedback && (
                        <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 animate-fade-in">
                            <div className="bg-white rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden p-6 text-center">
                                {feedback.isCorrect ? (
                                    <Icons.CheckCircle className="w-16 h-16 text-green-500 mx-auto mb-4" />
                                ) : (
                                    <Icons.XCircle className="w-16 h-16 text-red-500 mx-auto mb-4" />
                                )}
                                <h3 className={`text-2xl font-bold mb-4 ${feedback.isCorrect ? 'text-green-700' : 'text-red-700'}`}>
                                    {feedback.isCorrect ? '回答正確！' : '回答錯誤'}
                                </h3>
                                {!feedback.isCorrect && (
                                    <div className="bg-slate-50 p-4 rounded-lg mb-4">
                                        <p className="text-xs text-slate-500 uppercase">正確答案</p>
                                        <div className="text-xl font-bold text-slate-800 flex justify-center items-center gap-1">
                                            {feedback.correctAnsText}
                                        </div>
                                    </div>
                                )}
                                <button onClick={handleNext} className="w-full py-3 bg-slate-800 text-white rounded-xl font-bold hover:bg-slate-900">
                                    {isLast ? "查看成績" : "下一題 (Enter)"}
                                </button>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        // --- 各種測驗模式配置 ---

        function QuizMode1_Valence() {
            return <QuizRunner pool={VALENCE_DATA} type="valence" />;
        }

        function QuizMode1_Element() {
            return <QuizRunner pool={PERIODIC_ELEMENTS} type="element" />;
        }

        function QuizMode2_Mixed() {
            // 混合題庫：合併兩者，但移除重複
            // 邏輯：先放所有離子題，再放元素題。
            // 為了避免重複 (例如 H 既在離子 H +1 又在元素 H)，我們簡單過濾一下
            // 如果 PERIODIC_ELEMENTS 中的符號已經存在於 VALENCE_DATA 的 formula 中，則視為"相似"，但題目呈現方式不同 (一個有根價一個沒有)
            // 題目要求：不要有重複的題目。
            // 實作：將兩者合併。因為題型不同 (一個問 H+1, 一個問 H)，嚴格來說不算重複。
            // 但如果覺得太像，可以過濾。這裡依照指示「混合後出題」。
            // 為了體驗好，我們直接合併。使用者會看到 "H +1" (答:氫離子) 和 "H" (答:氫) 兩種不同題目，這符合化學學習邏輯。
            
            const mixedPool = [...VALENCE_DATA, ...PERIODIC_ELEMENTS];
            return <QuizRunner pool={mixedPool} type="mixed" />;
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
